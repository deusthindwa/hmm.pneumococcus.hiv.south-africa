#Written by Deus Thindwa
#Does household HIV-exposure increase infant risk of pneumococcal carriage acquisition?
#An analysis using markov transition model
#PhD chapter 2
#14/05/2019

#load required packages into memory
phirst.packages <-c("tidyverse","plyr", "msm")
lapply(phirst.packages, library, character.only=TRUE)

#simulate a phirst dataset
set.seed(12345)
sample.size=520
phirst <- data.frame(hhid=rep(letters[1:26], each=20), pid=rep.int(1:4, 5)) #household id, individual id
phirst$uid <- apply(phirst, 1 , function(x) paste0(toString(x[1]), toString(x[2]))) #household individual id
phirst$sample.date <- seq(as.Date('2018/01/01'), as.Date('2019/06/04'), by="day") #sample date
phirst <- ddply(phirst, .(uid), mutate, sample.point = seq_along(sample.date)) #sample point
phirst <- ddply(phirst, .(uid), mutate, age=rep(rnorm(n=sample.size, mean=20, sd=9.5), each=5, length.out=5)) #age
phirst$carrige <- sample(c("negative","positive"), size=sample.size, replace=TRUE) #carriage
phirst$serotype <- if_else(phirst$carrige=="positive", sample(c("1","3","5","6A","6B","14","19A","19F","23F"), size=sample.size, replace=TRUE),
                   if_else(phirst$carrige=="negative", NULL,NULL)) #serotype
phirst$hivstatus <- if_else(phirst$age<1, rep(sample(c("unexposed","exposed"), size=sample.size, replace=TRUE), each=5, length.out=520),
                           if_else(phirst$age>=1, rep(sample(c("negative","positive"), size=sample.size, replace=TRUE), each=5, length.out=520),NULL)) #hiv status

#analysis using "msm" R package
#load coronary allograft vasculopathy dataset
cav <- msm::cav

#exclude pdiag missing obs
cav <- cav[!is.na(cav$pdiag),]

#summarise number of transitions between states
cav[1:10,]
statetable.msm(cav$state, cav$PTNUM)

#construct a transition intensity matrix ..Q..with initial diffuse priors
transitionM <- rbind(c(0, 0.25, 0, 0.25), c(0.166, 0, 0.166, 0.166), c(0, 0.25, 0, 0.25), c(0, 0, 0, 0))
rownames(transitionM) <- colnames(transitionM) <- c("Well", "Mild", "Severe", "Death")

#calulate maximum likelihood estimates of the transition intensity matrix..Q
transitionMLE <- msm(state ~ years, subject=PTNUM, data=cav, qmatrix=transitionM, death=4)

#display fitted transition probability matrix over specified time interval of 1 year..Q=Exp(tQ)
pmatrix.msm(transitionMLE, t=1, ci="normal")

#fit transition intensity matrix..Q..with covariates
cav$ihd <- as.numeric(cav[,"pdiag"]=="IHD")
transitionMLE.cov <- msm(state ~ years, subject=PTNUM, data=cav, covariates=~dage+sex, qmatrix=transitionM,death=4,
                         method="BFGS", control=list(fnscale=4000, maxit=10000))

#obtain transition probability matrix at specified time interval of 1 year..Q=Exp(tQ)..by sex covariate
pmatrix.msm(transitionMLE.cov, t=1, ci="normal", covariates=list(sex=0))
pmatrix.msm(transitionMLE.cov, t=1, ci="normal", covariates=list(sex=1))

#calculate hazard ratios (cov value comparison) of transitioning between states log scale
hazard.msm(transitionMLE.cov)

#calculate transition intensity matrix of specified cov value
qmatrix.msm(transitionMLE.cov, covariates=list(dage=50,ihd=1))

#model comparisons
lrtest.msm(transitionMLE,transitionMLE.cov)

#hidden Markov model
fev <- msm::fev
three.q<-rbind(c(0,exp(-6),exp(-9)), c(0,0,exp(-6)), c(0,0,0))
hmodel1<-list(hmmNorm(mean=100, sd=16), hmmNorm(mean=54, sd=18), hmmIdent(999))

fev1.msm<-msm(fev~days, subject=ptnum, data=fev, 
              qmatrix=three.q, 
              hmodel=hmodel1, 
              hcovariates=list(~acute, ~acute, NULL),
              hconstraint=list(acute=c(1,1)),death=3, method="BFGS")

sojourn.msm(fev1.msm)
viterbi.msm(fev1.msm)

#misclassification
ematrix<- rbind(c(0,0.1,0,0), c(0.1,0,0.1,0), c(0,0.1,0,0), c(0,0,0,0))
rownames(ematrix)<-colnames(ematrix)<-c("Well","Mild","Severe","Death")
one4way<- rbind(c(0,0.1,0,0.04), c(0,0,0.3,0.05), c(0,0,0,0.3), c(0,0,0,0))
rownames(one4way)<-colnames(one4way)<-c("Well","Mild","Severe","Death")

misc.msm<-msm(state~years, subject=PTNUM, data=cav,
              qmatrix=one4way,
              ematrix=ematrix,
              obstrue=firstobs,
              death=TRUE,
              method="BFGS")




